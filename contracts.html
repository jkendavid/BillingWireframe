<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <title>Contracts</title>
</head>

<body>

  <div class="container mt-4">

    
    
    <h2>Contracts</h2>

    <!-- Table -->
    <table class="table table-bordered" id="dataTable">
      <thead>
        <tr>
          <th>Code</th>
          <th>Type</th>
          <th>Seller</th>
          <th>Buyer</th>
          <th>Start</th>
          <th>End</th>
          <th>Description</th>
          <th>Status</th>
          <th>Update By</th>
          <th>Update Time</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
<tr>
  <td>PSA-GENCO1-DU01-001</td>
  <td>PSA</td>
  <td>GEN01</td>
  <td>DU01</td>
  <td>2024-01</td>
  <td>2033-12</td>
  <td></td>
  <td>New</td>
  <td>MKTG</td>
  <td>01/01/2023 00:05</td></td><td><button class='btn btn-info btn-sm editButton' onclick='editEntry(this)'>Edit</button><button class='btn btn-info btn-sm approveButton' onclick='approveEntry(this)'>Approve</button></td>
</tr>
<tr>
  <td>PSA-GENCO1-RES01-001</td>
  <td>PSA</td>
  <td>GEN01</td>
  <td>RES01</td>
  <td>2024-01</td>
  <td>2043-12</td>
  <td></td>
  <td>New</td>
  <td>MKTG</td>
  <td>01/01/2023 00:05</td></td><td><button class='btn btn-info btn-sm editButton' onclick='editEntry(this)'>Edit</button><button class='btn btn-info btn-sm approveButton' onclick='approveEntry(this)'>Approve</button></td>
</tr>
<tr>
  <td>PSA-RESO1-CC01-001</td>
  <td>PSA</td>
  <td>RES01</td>
  <td>CC01</td>
  <td>2024-01</td>
  <td>2043-12</td>
  <td></td>
  <td>New</td>
  <td>MKTG</td>
  <td>01/01/2023 00:05</td></td><td><button class='btn btn-info btn-sm editButton' onclick='editEntry(this)'>Edit</button><button class='btn btn-info btn-sm approveButton' onclick='approveEntry(this)'>Approve</button></td>
</tr>

      </tbody>
    </table>

    <!-- Add New Button -->
    <button type="button" class="btn btn-primary" id="addNewButton" data-toggle="modal" data-target="#addNewModal">
        Add New
    </button>


  <!-- Add New Modal -->
  <div class="modal" id="addNewModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Entry</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Form for adding new entries -->
          <form id="addEntryForm">
            <input type="hidden" id="editRowIndex" value="">
            <div class="form-group">
              <label for="newName">Code</label>
              <input type="text" class="form-control" id="newName" required>
            </div>
            <div class="form-group">
              <label for="newType">Type</label>
              <select class="form-control" id="newType" required>
                <option value="PSA">PSA</option>
                <option value="RSC">RSC</option>
              </select>
            </div>
            <div class="form-group">
              <label for="newSeller">Seller</label>
              <select class="form-control" id="newSeller" required>
                <option value="GEN01">GEN01</option>
                <option value="RES01">RES01</option>
              </select>
            </div>
            <div class="form-group">
              <label for="newBuyer">Buyer</label>
              <select class="form-control" id="newBuyer" required>
                <option value="DU01">DU01</option>
                <option value="RES01">RES01</option>
                <option value="CC01">CC01</option>
              </select>
            </div>
            <div class="form-group">
              <label for="newStart">Start</label>
              <input type="month" class="form-control" id="newStart" required>
            </div>
            <div class="form-group">
              <label for="newEnd">End</label>
              <input type="month" class="form-control" id="newEnd" required>
            </div>
            <div class="form-group">
              <label for="newDescription">Description</label>
              <textarea class="form-control" id="newDescription" rows="3"></textarea>
            </div>

            <button type="button" class="btn btn-primary" onclick="addNewEntry()">Save</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script src="navbar.js"></script>
  <script>

    function addNewEntry() {
      // Get values from the form
      
      var userType = document.getElementById("user").value;
      var newName = document.getElementById("newName").value;
      var newType = document.getElementById("newType").value;
      var newSeller = document.getElementById("newSeller").value;
      var newBuyer = document.getElementById("newBuyer").value;
      var newStart = document.getElementById("newStart").value;
      var newEnd = document.getElementById("newEnd").value;
      var newDescription = document.getElementById("newDescription").value;

      // Validate input
      if (!newName || !newType || !newSeller || !newBuyer || !newStart || !newEnd) {
        alert("Please enter valid data.");
        return;
      }

      // Check if editing an existing entry
      var editing = document.getElementById("editRowIndex").value;
      if (editing !== "") {
        // Update existing row
        var row = document.getElementById("dataTable").rows[editing];
        row.cells[0].innerText = newName;
        row.cells[1].innerText = newType;
        row.cells[2].innerText = newSeller;
        row.cells[3].innerText = newBuyer;
        row.cells[4].innerText = newStart;
        row.cells[5].innerText = newEnd;
        row.cells[6].innerText = newDescription;
        row.cells[7].innerText = "New"; // Set the "Status" to "New"
        row.cells[8].innerText = userType; // Set the "Update By" to "MKTNG"
        row.cells[9].innerText = getCurrentTime(); // Update the "Update Time" field
        // Reset edit flag
        document.getElementById("editRowIndex").value = "";
      } else {
        // Create a new table row
        var newRow = document.createElement("tr");
        newRow.innerHTML = "<td>" + newName + "</td><td>" + newType + "</td><td>" +
          newSeller + "</td><td>" + newBuyer + "</td><td>" + newStart + "</td><td>" + newEnd + "</td><td>" +
          newDescription + "</td><td>New</td><td>" +userType + "</td><td>" + getCurrentTime() +
          "</td><td><button class='btn btn-info btn-sm editButton' onclick='editEntry(this)'>Edit</button><button class='btn btn-info btn-sm approveButton' onclick='approveEntry(this)'>Approve</button></td>";

        // Append the new row to the table
        document.getElementById("dataTable").getElementsByTagName('tbody')[0].appendChild(newRow);
        handleUserChange()
      }

      // Clear form fields
      document.getElementById("newName").value = "";
      document.getElementById("newType").value = ""; // Set default value for Type dropdown
      document.getElementById("newSeller").value = ""; // Set default value for Seller dropdown
      document.getElementById("newBuyer").value = ""; // Set default value for Buyer dropdown
      document.getElementById("newStart").value = "";
      document.getElementById("newEnd").value = "";
      document.getElementById("newDescription").value = "";
      document.getElementById("editRowIndex").value="";
      // Close the modal
      $('#addNewModal').modal('hide');
    }


    $('#addNewModal').on('shown.bs.modal', function () {
      document.getElementById("newName").value = "";
      document.getElementById("newType").value = ""; // Set default value for Type dropdown
      document.getElementById("newSeller").value = ""; // Set default value for Seller dropdown
      document.getElementById("newBuyer").value = ""; // Set default value for Buyer dropdown
      document.getElementById("newStart").value = "";
      document.getElementById("newEnd").value = "";
      document.getElementById("newDescription").value = "";
      document.getElementById("editRowIndex").value="";
    document.getElementById("newName").readOnly = false;
    document.getElementById("newType").disabled = false;
    document.getElementById("newSeller").disabled = false;
    document.getElementById("newBuyer").disabled = false;
    });


    // Function to get the current time in the format "YYYY-MM-DDTHH:mm"
    function getCurrentTime() {
      var now = new Date();
      var year = now.getFullYear();
      var month = (now.getMonth() + 1).toString().padStart(2, '0');
      var day = now.getDate().toString().padStart(2, '0');
      var hours = now.getHours().toString().padStart(2, '0');
      var minutes = now.getMinutes().toString().padStart(2, '0');
      return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
    }

    function editEntry(button) {
    // Retrieve the values from the selected row
    var row = button.closest('tr');
    var name = row.cells[0].innerText;
    var type = row.cells[1].innerText;
    var seller = row.cells[2].innerText;
    var buyer = row.cells[3].innerText;
    var start = row.cells[4].innerText;
    var end = row.cells[5].innerText;
    var description = row.cells[6].innerText;

    $('#addNewModal').modal('show');
    // Set the values in the modal for editing
    document.getElementById("newName").value = name;
    document.getElementById("newType").value = type;
    document.getElementById("newSeller").value = seller;
    document.getElementById("newBuyer").value = buyer;
    document.getElementById("newStart").value = start;
    document.getElementById("newEnd").value = end;
    document.getElementById("newDescription").value = description;

    // Set the index of the row being edited
    document.getElementById("editRowIndex").value = row.rowIndex;

    // Disable fields that should not be editable
    document.getElementById("newName").readOnly = true;
    document.getElementById("newType").disabled = true;
    document.getElementById("newSeller").disabled = true;
    document.getElementById("newBuyer").disabled = true;

    // Enable editable fields
    document.getElementById("newDescription").readOnly = false;
    document.getElementById("newStart").readOnly = false;
    document.getElementById("newEnd").readOnly = false;

    // Open the modal for editing
  }


  
  function approveEntry(button) {
    // Display a confirmation dialog
    var confirmation = confirm("Are you sure you want to approve this entry?");
    
    // If the user clicks "OK" (true), proceed with approval
    if (confirmation) {
        // Retrieve the values from the selected row
        var row = button.closest('tr');
        var statusCell = row.cells[7];

        // Check the user type
        var userType = document.getElementById("user").value;

        // If the user is "MKTG," hide the "Approve" button
        if (userType === "MKTG") {
            alert("MKTG user cannot approve entries.");
            return;
        }

        // Set the status to "Approved"
        statusCell.innerText = 'Approved';
        button.style.display = "none";
    } else {
        // If the user clicks "Cancel" (false), do nothing
    }
}


  
  function handleUserChange() {
        var userType = document.getElementById("user").value;
        var addButton = document.getElementById("addNewButton");
        var editButton = document.getElementsByClassName("editButton");
        var approveButton = document.getElementsByClassName("approveButton");

        // Hide or show buttons based on user type
        if (userType === "MKTG") {
            addButton.style.display = "block"; // Show "Add New" button
            for (var i = 0; i < editButton.length; i++) {
                editButton[i].style.display = "block"; // Show "Edit" buttons
                approveButton[i].style.display = "none"; 
            }
        } else if (userType === "MKTGMNGR") {
            addButton.style.display = "none"; // Hide "Add New" button
            for (var i = 0; i < editButton.length; i++) {
                editButton[i].style.display = "none"; // Hide "Edit" buttons

                if(approveButton[0].closest('tr').cells[7].innerText!='Approved') {
                    approveButton[i].style.display = "block"; 
                }
            }
        }
    }
    handleUserChange();
  </script>

</body>

</html>
